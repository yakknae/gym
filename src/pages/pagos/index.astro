---
// src/pages/pagos/index.astro
import Layout from "../../layouts/Layout.astro";
import { pagoService } from "../../services/pagoService";
import { formatInTimeZone } from "date-fns-tz";

// Obtener filtros de URL
const url = Astro.url;
const filtroEstado = url.searchParams.get("estado") || "Todos";

// Obtener pagos según filtro
let pagos;
if (filtroEstado === "Pendiente") {
  pagos = await pagoService.getPendientes();
} else if (filtroEstado === "Vencidos") {
  pagos = await pagoService.getVencidos();
} else if (filtroEstado === "Pagado") {
  pagos = await pagoService.getByEstado("Pagado");
} else {
  pagos = await pagoService.getAll();
}

// Obtener estadísticas
const stats = await pagoService.getEstadisticas();

// Formatear fechas
const formatearFecha = (fecha: any) => {
  if (!fecha) return "-";
  const fechaStr = typeof fecha === "string" ? fecha : fecha.toISOString().split("T")[0];

  return formatInTimeZone(
    `${fechaStr}T12:00:00`, // Poner mediodía para evitar problemas de timezone
    "America/Argentina/Buenos_Aires",
    "dd/MM/yyyy",
  );
};

// Calcular días de atraso
const calcularAtraso = (fechaProgramada: Date) => {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  const fecha = new Date(fechaProgramada);
  fecha.setHours(0, 0, 0, 0);
  const diff = Math.floor((hoy.getTime() - fecha.getTime()) / (1000 * 60 * 60 * 24));
  return diff > 0 ? diff : 0;
};
---

<Layout title="Gestión de Pagos">
  <!-- Header con estadísticas -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold text-white mb-1">Gestión de Pagos</h1>
        <p class="text-gray-400">Administrá los pagos y cobros del gimnasio</p>
      </div>
      <!-- BOTÓN NUEVO: Generar pagos del mes -->
      <div class="flex gap-3">
        <button
          id="btn-generar-pagos"
          class="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-400 border border-orange-500/30 rounded-xl text-white transition-all text-sm font-semibold shadow-lg shadow-orange-500/20"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Generar Pagos del Mes
        </button>
        <a
          href="/pagos/historial"
          class="flex items-center gap-2 px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-gray-300 hover:text-white hover:border-white/20 transition-all text-sm font-medium"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Ver Historial Completo
        </a>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-[#1a1a1a] border border-white/5 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-blue-500/10 rounded-lg">
            <svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              ></path>
            </svg>
          </div>
          <div>
            <p class="text-gray-400 text-xs">Total</p>
            <p class="text-white text-2xl font-bold">{stats.total}</p>
          </div>
        </div>
      </div>

      <div class="bg-[#1a1a1a] border border-white/5 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-green-500/10 rounded-lg">
            <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div>
            <p class="text-gray-400 text-xs">Pagados</p>
            <p class="text-white text-2xl font-bold">{stats.pagados}</p>
          </div>
        </div>
      </div>

      <div class="bg-[#1a1a1a] border border-white/5 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-orange-500/10 rounded-lg">
            <svg class="w-5 h-5 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div>
            <p class="text-gray-400 text-xs">Pendientes</p>
            <p class="text-white text-2xl font-bold">{stats.pendientes}</p>
          </div>
        </div>
      </div>

      <div class="bg-[#1a1a1a] border border-white/5 rounded-xl p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-red-500/10 rounded-lg">
            <svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
          <div>
            <p class="text-gray-400 text-xs">Vencidos</p>
            <p class="text-white text-2xl font-bold">{stats.vencidos}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bg-[#1a1a1a] border border-white/5 rounded-xl p-4">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-400 font-medium">Filtrar:</span>
        <a
          href="/pagos"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            filtroEstado === "Todos"
              ? "bg-orange-500 text-white"
              : "bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white"
          }`}
        >
          Todos
        </a>
        <a
          href="/pagos?estado=Pendiente"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            filtroEstado === "Pendiente"
              ? "bg-orange-500 text-white"
              : "bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white"
          }`}
        >
          Pendientes
        </a>
        <a
          href="/pagos?estado=Vencidos"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            filtroEstado === "Vencidos"
              ? "bg-orange-500 text-white"
              : "bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white"
          }`}
        >
          Vencidos
        </a>
        <a
          href="/pagos?estado=Pagado"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            filtroEstado === "Pagado"
              ? "bg-orange-500 text-white"
              : "bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white"
          }`}
        >
          Pagados
        </a>
      </div>
    </div>
  </div>

  <!-- Tabla de Pagos -->
  <div class="bg-[#1a1a1a] rounded-xl shadow-xl border border-orange-500/30 overflow-hidden">
    <table class="w-full text-left border-collapse">
      <thead class="bg-[#0f0f0f] border-b border-orange-500/30">
        <tr>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Socio</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Plan</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Mes</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Fecha Programada</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Fecha Pago</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Estado</th>
          <th class="px-6 py-4 text-sm font-semibold text-orange-500 tracking-wider text-center">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-orange-500/10">
        {
          pagos.length === 0 ? (
            <tr>
              <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                No hay pagos que mostrar con los filtros seleccionados
              </td>
            </tr>
          ) : (
            pagos.map((pago) => {
              const atraso = pago.estado_pago === "Pendiente" ? calcularAtraso(pago.fecha_programada) : 0;

              return (
                <tr class="hover:bg-orange-500/5 transition-colors">
                  <td class="px-6 py-4">
                    <div class="font-medium text-white text-center">
                      {pago.socios?.nombre} {pago.socios?.apellido}
                    </div>
                    <div class="text-xs text-gray-500 text-center">DNI: {pago.socios?.dni}</div>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <span class="text-xs font-medium px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">
                      {pago.planes?.nombre_plan}
                    </span>
                  </td>
                  <td class="px-6 py-4 text-sm text-white text-center">{formatearFecha(pago.mes_correspondiente)}</td>
                  <td class="px-6 py-4 text-sm text-white text-center">{formatearFecha(pago.fecha_programada)}</td>
                  <td class="px-6 py-4 text-sm text-gray-400 text-center">{formatearFecha(pago.fecha_pago)}</td>
                  <td class="px-6 py-4 text-center">
                    {pago.estado_pago === "Pagado" ? (
                      <span class="text-xs font-medium px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                        Pagado
                      </span>
                    ) : atraso > 0 ? (
                      <div class="flex flex-col items-center gap-1">
                        <span class="text-xs font-medium px-3 py-1 rounded-full bg-red-500/20 text-red-400 border border-red-500/30">
                          Vencido
                        </span>
                        <span class="text-[10px] text-red-400">{atraso} días</span>
                      </div>
                    ) : (
                      <span class="text-xs font-medium px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 border border-orange-500/30">
                        Pendiente
                      </span>
                    )}
                  </td>
                  <td class="px-6 py-4 text-center">
                    {pago.estado_pago === "Pendiente" ? (
                      <button
                        class="p-2 hover:bg-green-500/20 text-green-400 rounded-md transition-colors border border-transparent hover:border-green-500/50 btn-pagar"
                        data-id={pago.id_pago}
                        title="Marcar como pagado"
                      >
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                      </button>
                    ) : (
                      <span class="text-xs text-gray-600">-</span>
                    )}
                  </td>
                </tr>
              );
            })
          )
        }
      </tbody>
    </table>
  </div>
  <script>
    const botonesPagar = document.querySelectorAll(".btn-pagar");

    botonesPagar.forEach((boton) => {
      boton.addEventListener("click", async () => {
        const id = boton.getAttribute("data-id");

        if (confirm("¿Confirmar que este pago fue realizado?")) {
          try {
            const res = await fetch(`/api/pagos/${id}/`, {
              method: "POST",
            });

            if (res.ok) {
              location.reload();
            } else {
              alert("Error al marcar el pago");
            }
          } catch (error) {
            alert("Error de conexión");
          }
        }
      });
    });

    // Script para generar pagos del mes
    const btnGenerarPagos = document.getElementById("btn-generar-pagos") as HTMLButtonElement;

    btnGenerarPagos?.addEventListener("click", async () => {
      if (!confirm("¿Generar los pagos del mes actual para todos los socios activos?")) {
        return;
      }

      // Guardar el HTML original del botón
      const originalText = btnGenerarPagos.innerHTML;
      btnGenerarPagos.disabled = true;
      btnGenerarPagos.innerHTML = `
      <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Generando...
    `;

      try {
        const res = await fetch("/api/pagos/", {
          method: "POST",
        });

        const data = await res.json();

        if (res.ok) {
          alert(data.message || "Pagos generados exitosamente");
          location.reload();
        } else {
          alert(data.error || "Error al generar los pagos");
          btnGenerarPagos.disabled = false;
          btnGenerarPagos.innerHTML = originalText;
        }
      } catch (error) {
        alert("Error de conexión");
        btnGenerarPagos.disabled = false;
        btnGenerarPagos.innerHTML = originalText;
      }
    });
  </script>
</Layout>
