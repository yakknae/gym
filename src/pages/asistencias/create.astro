---
// src/pages/asistencias/nueva.astro
import Layout from "../../layouts/Layout.astro";
import { db } from "../../lib/db";
import { formatInTimeZone } from "date-fns-tz";

// Obtenemos todos los socios para el select
const socios = await db.socios.findMany({
  orderBy: {
    nombre: "asc",
  },
});
---

<Layout title="Registrar Asistencia">
  <div class="max-w-4xl mx-auto">
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-1">
        <a
          href="/asistencias"
          class="text-gray-500 hover:text-orange-400 transition-colors text-sm flex items-center gap-1.5"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Planilla de Asistencias
        </a>
        <span class="text-gray-600">/</span>
        <span class="text-gray-400 text-sm">Nuevo registro</span>
      </div>
      <h1 class="text-3xl font-bold text-white">Registrar Asistencia</h1>
      <p class="text-gray-400 mt-1">Selecciona al socio para marcar su ingreso hoy</p>
    </div>

    <form id="form-asistencia" class="space-y-6">
      <div class="bg-[#1a1a1a] border border-white/5 rounded-2xl p-6 shadow-xl">
        <h2 class="text-sm font-semibold text-orange-400 uppercase tracking-widest mb-5">Ingreso al Gimnasio</h2>

        <div class="flex flex-col gap-1.5">
          <label class="text-sm text-gray-400 font-medium">Socio <span class="text-orange-500">*</span></label>
          <select
            name="id_socio"
            required
            class="bg-[#0f0f0f] border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/20 transition-all text-sm appearance-none"
          >
            <option value="" disabled selected>Selecciona un socio...</option>
            {
              socios.map((socio) => (
                <option value={socio.id_socio}>
                  {socio.nombre} {socio.apellido} - {socio.dni}
                </option>
              ))
            }
          </select>
          <p class="text-[11px] text-gray-500 mt-1 italic">La fecha y hora se registrar치n autom치ticamente.</p>
        </div>
      </div>

      <div class="flex justify-end gap-3 pb-4">
        <a
          href="/asistencias"
          class="px-6 py-3 rounded-xl border border-white/10 text-gray-400 hover:text-white hover:border-white/20 transition-all text-sm font-medium"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="px-8 py-3 bg-orange-500 hover:bg-orange-400 text-white rounded-xl font-semibold text-sm transition-all shadow-lg shadow-orange-500/20 hover:shadow-orange-500/30 active:scale-95 flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Guardar Asistencia
        </button>
      </div>
    </form>
  </div>

  <script>
    import { formatInTimeZone } from "date-fns-tz";
    const form = document.getElementById("form-asistencia") as HTMLFormElement;

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      const fechaArgentina = formatInTimeZone(new Date(), "America/Argentina/Buenos_Aires", "yyyy-MM-dd");
      const data = {
        id_socio: parseInt(formData.get("id_socio") as string),
        fecha: fechaArgentina, // Guardar en UTC (est치ndar)
      };

      try {
        const res = await fetch("/api/asistencias", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          window.location.href = "/asistencias";
        } else {
          const err = await res.json();
          alert(err.error || "Error al registrar la asistencia");
        }
      } catch (error) {
        alert("Ocurri칩 un problema con el servidor.");
      }
    });
  </script>
</Layout>
